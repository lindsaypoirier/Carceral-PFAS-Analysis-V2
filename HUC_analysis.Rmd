---
title: "HUC Analysis"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

The purpose of the code presented in this document is to determine how many carceral facilities have potential exposures to PFAS through proximity to potential PFAS points sources, and how many incarcerated people are impacted. Towards this end, the code:

1. Loads the .gpkg files created in HUC_analysis.Rmd
2. Joins carceral facility data to data representing the locations of each potential point source based on a shared HUC-12 code
3. Filters to carceral facilities at a lower elevation than a potential point source as a proxy for hydrological flow direction
4. Calculates the number of unique facilities in the same HUC-12 watershed boundary and at a lower elevation than each point source and a combination of point sources, along with the number of incarcerated people potentially impacted
5. Presents increasingly conservative calculations by filtering the values down depending on whether facilities have been designated as not closed

## Load Packages

```{r}
library(tidyverse)
library(sf)
library(rgeos)
```

## Load source data

```{r}
pb_sf <- st_read("source_datasets/Prison_Boundaries-shp/Prison_Boundaries.shp") %>%
  st_transform(crs = 4269) %>%
  st_transform(crs = 32617) %>% #convert to utm for calculating centroids
  st_centroid() %>% #centroids from original multipolygons
  st_transform(crs = 4269) #back to 4269
```

## Load point sources with HUC-12 and elevations 

All of these files were created in get_HUC_elevation.Rmd.

```{r}
pb_huc_elevation <- st_read("huc_elevation_datasets/pb_HUC_elevation.gpkg")

pb_huc_elevation_not_closed <- 
  pb_huc_elevation %>%
  filter(STATUS != "CLOSED")

susp_cont_huc_elevation <- st_read("huc_elevation_datasets/susp_cont_HUC_elevation.gpkg")
```

## Join Point Sources to Carceral Facilities with Shared HUC-12

This code will perform an inner join to link carceral facilities with PFAS point sources that share the same HUC-12 watershed boundary. It will filter to carceral facilities at a lower elevation than point sources.

It will result in a data frame that can be used to calculate the total carceral facilities in the same HUC-12 watershed boundary and at a lower elevation than a PFAS point source. Note that at this point there may be duplicate carceral facilities in the data frame if there were multiple point sources in the same HUC-12 watershed boundary at a higher elevation than the carceral facility.

```{r}
joined_df <-
  pb_huc_elevation %>%
  select(-elev_units) %>%
  rename(ELEVATION_CARCERAL = elevation) %>%
  st_set_geometry(NULL) %>%
  inner_join(susp_cont_huc_elevation %>% 
                 st_set_geometry(NULL), 
               by = "HUC") %>%
    filter(ELEVATION_CARCERAL < elevation) %>%
    mutate(POPULATION = na_if(POPULATION, -999)) %>%
    rename(SUSP_CONT_ID_COLUMN = Index,
           SUSP_CONT_SOURCE = Source,
           SUSP_CONT_DETAILS = Details) %>% 
    select(FACILITYID, POPULATION, STATUS, TYPE, SECURELVL, SUSP_CONT_SOURCE, SUSP_CONT_DETAILS, SUSP_CONT_ID_COLUMN, SUSP_CONT_ID_COLUMN)

```

## Calculate Numbers and Percentages of Carceral Facilities in Proximity to Point Source

This code calculates the number, percentage, and populations of carceral facilities in the same HUC-12 and at a lower elevation than each point source. The previous code produced a data frame in which a carceral facility may have been listed multiple times if there was more than one point source in the same HUC-12 and at a higher elevation. This code reduces the file to unique carceral facilities by grouping variables specific to the facility. It then counts the number of observations in the data frame, the percentage of the total carceral facilities in the US this number represents, and the number of inmates potentially impacted. It performs the same operations filtering to not closed carceral facilities.

```{r}
by_source <- 
  joined_df %>%
  group_by(SUSP_CONT_SOURCE) %>%
  select(FACILITYID, POPULATION, STATUS, TYPE, SECURELVL) %>%
  distinct() %>%
  summarize(TOTAL_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pb_huc_elevation) * 100,
            AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(STATUS != "CLOSED", na.rm = TRUE),
            PERC_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(STATUS != "CLOSED", na.rm = TRUE) / nrow(pb_huc_elevation_not_closed) * 100, 
            AT_LEAST_NOT_CLOSED_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[STATUS != "CLOSED"], na.rm = TRUE)
            )

```

## Calculate Numbers and Percentages of Carceral Facilities in Proximity to Any Point Source

This duplicates the code above without grouping by the suspected contamination source. 

```{r}
at_least_one_source <-
  joined_df %>%
  select(FACILITYID, POPULATION, STATUS, TYPE, SECURELVL) %>%
  distinct() %>%
  summarize(TOTAL_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pb_huc_elevation) * 100,
            AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(STATUS != "CLOSED", na.rm = TRUE),
            PERC_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(STATUS != "CLOSED", na.rm = TRUE) / nrow(pb_huc_elevation_not_closed) * 100, 
            AT_LEAST_NOT_CLOSED_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[STATUS != "CLOSED"], na.rm = TRUE)
            ) %>%
  mutate(SUSP_CONT_SOURCE = "At least one") %>%
  relocate(SUSP_CONT_SOURCE, .before = TOTAL_CARC_FAC_WITH_POINT_SOURCE_IN_HUC)

```

## Calculate Numbers and Percentages of Carceral Facilities in Proximity to Multiple Point Sources

Inputs:

* A number serving as a threshold for how many point sources to check whether proximate

Purpose: 

This replicates the above point source calculations but also takes as an input a threshold for the number of point sources to check whether carceral facilities are in proximity to. It:

* groups rows representing the same carceral facility, 
* filters to groups in which the number of observations (in this case representing proximate point sources) is greater than the threshold, 
* selects variables related to carceral facilities and subsets to distinct carceral facilities

After this, the same calculations are performed as those performed above.

```{r}
more_than_one_point_source_calculation <- function(threshold) {
  joined_df %>%
  group_by(FACILITYID) %>%
  filter(n() > threshold) %>%
  ungroup() %>%
  select(FACILITYID, POPULATION, STATUS, TYPE, SECURELVL) %>%
  distinct() %>%
  summarize(TOTAL_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pb_huc_elevation) * 100,
            AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(STATUS != "CLOSED", na.rm = TRUE),
            PERC_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(STATUS != "CLOSED", na.rm = TRUE) / nrow(pb_huc_elevation_not_closed) * 100, 
            AT_LEAST_NOT_CLOSED_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[STATUS != "CLOSED"], na.rm = TRUE)
            ) %>%
  mutate(SUSP_CONT_SOURCE = paste("More than", threshold )) %>%
  relocate(SUSP_CONT_SOURCE, .before = TOTAL_CARC_FAC_WITH_POINT_SOURCE_IN_HUC)
}

more_than_one_source <- more_than_one_point_source_calculation(1)
more_than_five_source <- more_than_one_point_source_calculation(5)
```

```{r}
table1 <- 
  rbind(
    by_source, 
    at_least_one_source,
    more_than_one_source,
    more_than_five_source
    )

write.csv(table1, "final_datasets/table1.csv")
table1
```

## Perform Point Source Calculations by Type to Create Table 2

This takes the data frame created above in which each row represents a carceral facility/proximate PFAS point source pair. First it determines the distinct not closed carceral facilities that are proximate to at least one point source. The number of rows in this data frame is used as the denominator when calculating percentages in the first columns of this table. It also determines the distinct not closed *juvenile* carceral facilities that are proximate to at least one point source. The number of rows in this data frame is used as the denominator when calculating percentages in the final columns of this table. It then calculates the number, percentage, and populations of not closed carceral facilities proximate to at least one point source, as well as the number, percentage, and populations of not closed *juvenile* carceral facilities proximate to at least one point source. 

```{r}
pbs_in_point_source_watershed_join_not_closed <- 
  joined_df %>%
  filter(STATUS != "CLOSED") %>%
  select(FACILITYID, POPULATION, STATUS, TYPE, SECURELVL) %>%
  distinct()

pbs_in_point_source_watershed_join_not_closed_juv <- 
  joined_df %>%
  filter(SECURELVL == "JUVENILE") %>%
  select(FACILITYID, POPULATION, STATUS, TYPE, SECURELVL) %>%
  distinct()

by_type <-
  pbs_in_point_source_watershed_join_not_closed %>%
  group_by(TYPE) %>%
  summarize(NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pbs_in_point_source_watershed_join_not_closed) * 100,
            AT_LEAST_NOT_CLOSED_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            JUV_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE"),
            PERC_JUV_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE") / nrow(pbs_in_point_source_watershed_join_not_closed_juv) * 100,
            AT_LEAST_JUV_NOT_CLOSED_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[SECURELVL == "JUVENILE"], na.rm = TRUE))

by_type_totals <-
  pbs_in_point_source_watershed_join_not_closed %>%
  summarize(TYPE = "Total",
            NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pbs_in_point_source_watershed_join_not_closed) * 100,
                        AT_LEAST_NOT_CLOSED_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            JUV_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE"),
            PERC_JUV_NOT_CLOSED_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE") / nrow(pbs_in_point_source_watershed_join_not_closed_juv) * 100,
            AT_LEAST_JUV_NOT_CLOSED_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[SECURELVL == "JUVENILE"], na.rm = TRUE))

table2 <- 
  rbind(by_type, by_type_totals)

write.csv(table2, "final_datasets/table2.csv")
table2
```




