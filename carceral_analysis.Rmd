---
title: "HUC Analysis"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

The purpose of the code presented in this document is to determine how many carceral facilities have potential exposures to PFAS through proximity to potential PFAS points sources, and how many incarcerated people are impacted. Towards this end, the code:

1. Loads the .gpkg files created in `get_HUC_elevation.Rmd`
2. Joins carceral facility data to data representing the locations of each potential point source based on a shared HUC-12 code
3. Filters to carceral facilities at a lower elevation than a potential point source as a proxy for hydrological flow direction
4. Calculates the number of unique facilities in the same HUC-12 watershed boundary and at a lower elevation than each point source and a combination of point sources, along with the number of incarcerated people potentially impacted
5. Disaggregates the results by a number of variables

## Load Packages

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(sf)
library(rgeos)
```

## Load point sources with HUC-12 and elevations 

All of these files were created in `get_HUC_elevation.Rmd`.

```{r}
pb_huc_elevation <- st_read("huc_elevation_datasets/pb_HUC_elevation_block.gpkg") %>%
    mutate(POPULATION = na_if(POPULATION, -999)) %>%
  filter(STATUS != "CLOSED") %>%
  mutate(REGION = case_when(
    STATE %in% c("CA", "WA", "OR", "HI", "AK") ~ "PACIFIC",
    STATE %in% c("AZ", "CO", "ID", "NM", "MT", "UT", "NV", "WY") ~ "MOUNTAIN",
    STATE %in% c("IA", "KS", "MN", "MO", "NE","ND", "SD") ~ "WEST NORTH CENTRAL",
    STATE %in% c("IN", "IL", "MI", "OH", "WI") ~ "EAST NORTH CENTRAL",
    STATE %in% c("AR", "LA", "OK", "TX") ~ "WEST SOUTH CENTRAL",
    STATE %in% c("AL", "KY", "MS", "TN") ~ "EAST SOUTH CENTRAL",
    STATE %in% c("NJ", "NY", "PA") ~ "MID ATLANTIC",
    STATE %in% c("MA", "CT", "RI", "VT", "NH", "ME") ~ "NEW ENGLAND",
    STATE %in% c("DE", "DC", "GA", "MD", "NC", "SC", "VA", "WV", "FL") ~ "SOUTH ATLANTIC",
    TRUE ~ "OUTLYING"
    ))

pb_huc_elevation_juv <- pb_huc_elevation %>%
  filter(SECURELVL == "JUVENILE")

pb_huc_elevation_urban <- pb_huc_elevation %>%
  filter(URBAN == "URBAN") 

susp_cont_huc_elevation <- st_read("huc_elevation_datasets/susp_cont_HUC_elevation.gpkg") %>%
  mutate(Source = case_when(Source == "Formerly Used Defense Sites" |
                     Source == "Military Installations, Ranges, and Training Areas" ~ "Military Installment",
                   TRUE ~ Source))

pfas_huc_elevation <- st_read("huc_elevation_datasets/pfas_huc_elevation.gpkg") %>%
  mutate(industry = case_when(
    industry == "Military" ~ "Military Installment",
    industry == "Landfill" ~ "Industrial Facilities",
    industry == "Industry" ~ "Industrial Facilities",
    industry == "Fire Department/Training Facility" ~ "Industrial Facilities",
    industry == "Airport" ~ "Major Airports (FAA Part 139)",
    industry == "Unknown" ~ "Other",
    industry == "WWTP" ~ "Wastewater Treatment Plants",
    industry == "Superfund Site" ~ "Industrial Facilities",
    industry == "Dry Cleaner" ~ "Industrial Facilities",
    industry == "Waste" ~ "Waste",
    industry == "Other" ~ "Other"
  )) 

write.csv(pb_huc_elevation %>% st_drop_geometry(), "final_datasets/pb_huc_elevation.csv")
```

## How many carceral facilities are missing population data? Are certain types have more missing information than others?

```{r}
missing_pop_juv <-
  pb_huc_elevation %>%
  st_drop_geometry() %>%
  mutate(MISSING_POPULATION = case_when(is.na(POPULATION) ~ 1,
                             TRUE ~ 0),
         JUVENILE = case_when(SECURELVL == "JUVENILE" ~ "YES",
                              TRUE ~ "NO")) %>%
  group_by(JUVENILE) %>%
  summarize(Total = n(),
            Count_Missing_Pop = sum(MISSING_POPULATION), 
            Percent_Missing_Pop = Count_Missing_Pop/n()*100)

missing_pop_type <-
  pb_huc_elevation %>%
  st_drop_geometry() %>%
  mutate(MISSING_POPULATION = case_when(is.na(POPULATION) ~ 1,
                             TRUE ~ 0)) %>%
  group_by(TYPE) %>%
  summarize(Total = n(),
            Count_Missing_Pop = sum(MISSING_POPULATION), 
            Percent_Missing_Pop = Count_Missing_Pop/n()*100)
  
```

## Presumptive and Known Point Source Analysis

### Join Presumptive Point Sources to Carceral Facilities with Shared HUC-12

This code will perform an inner join to link carceral facilities with PFAS point sources that share the same HUC-12 watershed boundary. It will filter to carceral facilities at a lower elevation than point sources.

It will result in a data frame that can be used to calculate the total carceral facilities in the same HUC-12 watershed boundary and at a lower elevation than a PFAS point source. Note that at this point there may be duplicate carceral facilities in the data frame if there were multiple point sources in the same HUC-12 watershed boundary at a higher elevation than the carceral facility.

```{r message=FALSE, warning=FALSE, include=FALSE}
pb_susp_cont_joined <-
  pb_huc_elevation %>%
  select(-elev_units) %>%
  rename(ELEVATION_CARCERAL = elevation) %>%
  st_set_geometry(NULL) %>%
  inner_join(susp_cont_huc_elevation %>% 
                 st_set_geometry(NULL), 
               by = "HUC") %>%
    filter(ELEVATION_CARCERAL < elevation) %>%
    rename(SUSP_CONT_ID_COLUMN = Index,
           SUSP_CONT_SOURCE = Source,
           SUSP_CONT_DETAILS = Details) %>% 
    select(FACILITYID, POPULATION, TYPE, SECURELVL, URBAN, STATE, REGION, SUSP_CONT_SOURCE, SUSP_CONT_DETAILS, SUSP_CONT_ID_COLUMN, SUSP_CONT_ID_COLUMN, LATITUDE, LONGITUDE)

write.csv(pb_susp_cont_joined, "final_datasets/pb_susp_cont_joined.csv")
```

### Join Known Point Sources to Carceral Facilities with Shared HUC-12

```{r}
pb_pfas_joined <-
  pb_huc_elevation %>%
  select(-elev_units) %>%
  rename(ELEVATION_CARCERAL = elevation) %>%
  st_set_geometry(NULL) %>%
  inner_join(pfas_huc_elevation %>% 
                 st_set_geometry(NULL), 
               by = "HUC") %>%
    filter(ELEVATION_CARCERAL < elevation) %>%
    rename(PFAS_ID_COLUMN = map_id,
           PFAS_NAME = site_name,
           PFAS_INDUSTRY = industry,
           PFAS_SOURCE = suspected_source,
           PFAS_STATE = state,
           PFAS_LEVEL = pfas_level) %>% 
    select(FACILITYID, NAME, POPULATION, TYPE, SECURELVL, URBAN, STATE, REGION, PFAS_ID_COLUMN, PFAS_NAME, PFAS_INDUSTRY, PFAS_SOURCE, PFAS_LEVEL, LATITUDE, LONGITUDE)

write.csv(pb_pfas_joined, "final_datasets/pb_pfas_joined.csv")
```

# For each carceral facility determine whether juvenile, colocated to known site, and colocated to presumptive site

Purpose: This data will be used to perform statistical tests. 

```{r}
unique_carc_known <-
  pb_pfas_joined %>%
  distinct(FACILITYID) %>%
  mutate(KNOWN = TRUE) %>%
  select(FACILITYID, KNOWN)

unique_carc_susp <-
  pb_susp_cont_joined %>%
  distinct(FACILITYID) %>%
  mutate(SUSP = TRUE) %>%
  select(FACILITYID, SUSP)

colocated_by_facility <-  
  pb_huc_elevation %>%
  st_drop_geometry() %>%
  mutate(JUVENILE = case_when(SECURELVL == "JUVENILE" ~ "JUVENILE",
                              TRUE ~ "NOT_JUVENILE")) %>%
  select(FACILITYID, JUVENILE) %>%
  left_join(unique_carc_susp) %>%
  left_join(unique_carc_known) %>%
  replace_na(list(KNOWN = FALSE, SUSP = FALSE)) %>%
  mutate(DIFF = case_when(SUSP != KNOWN ~ TRUE, 
                          TRUE ~ FALSE))

write.csv(colocated_by_facility, "final_datasets/colocated_by_facility.csv")
```


### Calculate Numbers and Percentages of Carceral Facilities in Proximity to Different Thresholds of Point Sources

Purpose: 

This code calculates the number, percentage, and populations of carceral facilities in the same HUC-12 and at a lower elevation than each point source. The previous code produced a data frame in which a carceral facility may have been listed multiple times if there was more than one point source in the same HUC-12 and at a higher elevation. This code reduces the file to unique carceral facilities by grouping variables specific to the facility. It then counts the number of observations in the data frame, the percentage of the total carceral facilities in the US this number represents, and the number of inmates potentially impacted. Specifically,

* groups rows representing the same carceral facility, 
* filters to groups in which the number of observations (in this case representing proximate point sources) is greater than the threshold, 
* selects variables related to carceral facilities and subsets to distinct carceral facilities

After this, the same calculations are performed as those performed above.

```{r}
point_source_calculation <- function(source, threshold, text) {
  source %>%
  group_by(FACILITYID) %>%
  filter(n() > threshold) %>%
  ungroup() %>%
  select(FACILITYID, POPULATION, TYPE, SECURELVL, URBAN) %>%
  distinct() %>%
  summarize(CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pb_huc_elevation) * 100, 
            AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE"),
            PERC_JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE") / nrow(pb_huc_elevation_juv) * 100,
            AT_LEAST_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[SECURELVL == "JUVENILE"], na.rm = TRUE),
            NON_JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL != "JUVENILE"),
            PERC_NON_JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL != "JUVENILE") / (nrow(pb_huc_elevation) - nrow(pb_huc_elevation_juv)) * 100,
            AT_LEAST_NON_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[SECURELVL != "JUVENILE"], na.rm = TRUE),
            URBAN_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(URBAN == "URBAN"),
            PERC_URBAN_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(URBAN == "URBAN") / nrow(pb_huc_elevation_urban) * 100,
            AT_LEAST_URBAN_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[URBAN == "URBAN"], na.rm = TRUE),
            NON_URBAN_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(URBAN != "URBAN"),
            PERC_NON_URBAN_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(URBAN != "URBAN") / (nrow(pb_huc_elevation) - nrow(pb_huc_elevation_urban)) * 100,
            AT_LEAST_NON_URBAN_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[URBAN != "URBAN"], na.rm = TRUE)
            ) %>%
  mutate(SUSP_CONT_SOURCE = paste("More than", threshold, text, "point sources" )) %>%
  relocate(SUSP_CONT_SOURCE, .before = CARC_FAC_WITH_POINT_SOURCE_IN_HUC)
}

at_least_one_susp_source <- point_source_calculation(pb_susp_cont_joined, 0, "presumptive")
more_than_one_susp_source <- point_source_calculation(pb_susp_cont_joined, 1, "presumptive")
more_than_five_susp_source <- point_source_calculation(pb_susp_cont_joined, 5, "presumptive")
at_least_one_known_source <- point_source_calculation(pb_pfas_joined, 0, "known")
more_than_one_known_source <- point_source_calculation(pb_pfas_joined, 1, "known")
more_than_five_known_source <- point_source_calculation(pb_pfas_joined, 5, "known")

totals_table <- 
  rbind(at_least_one_susp_source, 
        more_than_one_susp_source, 
        more_than_five_susp_source,
        at_least_one_known_source, 
        more_than_one_known_source, 
        more_than_five_known_source)

write.csv(totals_table, "final_datasets/totals_table.csv")

rm(at_least_one_susp_source,
   more_than_one_susp_source,
   more_than_five_susp_source,
   at_least_one_known_source, 
   more_than_one_known_source, 
   more_than_five_known_source
)
```

### Calculate Numbers and Percentages of Carceral Facilities in Proximity to Presumptive Point Source by Source

```{r message=FALSE, warning=FALSE, include=FALSE}
susp_by_source <- 
  pb_susp_cont_joined %>%
  group_by(SUSP_CONT_SOURCE) %>%
  select(FACILITYID, POPULATION, TYPE, SECURELVL) %>%
  distinct() %>%
  summarize(CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pb_huc_elevation) * 100, 
            AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE"),
            PERC_JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE") / nrow(pb_huc_elevation_juv) * 100,
            AT_LEAST_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[SECURELVL == "JUVENILE"], na.rm = TRUE)
            )

write.csv(susp_by_source, "final_datasets/susp_by_source_table.csv")

rm(susp_by_source_table)
```

### Calculate Numbers and Percentages of Carceral Facilities in Proximity to Known Point Source by Source

This code calculates the number, percentage, and populations of carceral facilities in the same HUC-12 and at a lower elevation than each point source. The previous code produced a data frame in which a carceral facility may have been listed multiple times if there was more than one point source in the same HUC-12 and at a higher elevation. This code reduces the file to unique carceral facilities by grouping variables specific to the facility. It then counts the number of observations in the data frame, the percentage of the total carceral facilities in the US this number represents, and the number of inmates potentially impacted.

```{r message=FALSE, warning=FALSE, include=FALSE}
known_by_source <- 
  pb_pfas_joined %>% 
  group_by(PFAS_INDUSTRY) %>%
  select(FACILITYID, POPULATION, TYPE, SECURELVL) %>%
  distinct() %>%
  summarize(CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
            PERC_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n() / nrow(pb_huc_elevation) * 100, 
            AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION, na.rm = TRUE),
            JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE"),
            PERC_JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = sum(SECURELVL == "JUVENILE") / nrow(pb_huc_elevation_juv) * 100,
            AT_LEAST_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC = sum(POPULATION[SECURELVL == "JUVENILE"], na.rm = TRUE)
            )

write.csv(known_by_source, "final_datasets/known_by_source_table.csv")

rm(known_by_source_table)
```

### Perform Presumptive Point Source Calculations by Type

This takes the data frame created above in which each row represents a carceral facility/proximate PFAS point source pair. First it determines the distinct not closed carceral facilities that are proximate to at least one point source. The number of rows in this data frame is used as the denominator when calculating percentages in the first columns of this table. The number of rows in this data frame is used as the denominator when calculating percentages in the final columns of this table. It then calculates the number, percentage, and populations of not closed carceral facilities proximate to at least one point source. 

```{r}
facility_type_totals <- 
  pb_huc_elevation %>%
  st_drop_geometry() %>%
  group_by(TYPE) %>%
  summarize(TYPE_COUNT = n(),
            JUV_TYPE_COUNT = sum(SECURELVL == "JUVENILE", na.rm = TRUE),
            NON_JUV_TYPE_COUNT = sum(SECURELVL != "JUVENILE", na.rm = TRUE),
            POP_COUNT = sum(POPULATION, na.rm = TRUE))

by_type_table <- function(source){
  
  pbs_at_least_one <- 
    source %>%
    select(FACILITYID, POPULATION, TYPE, SECURELVL) %>%
    distinct()

  pbs_at_least_one_juv <-
    pbs_at_least_one %>%
    filter(SECURELVL == "JUVENILE")
  
  by_pb_type <-
    pbs_at_least_one %>%
    left_join(facility_type_totals, by = "TYPE") %>%
    group_by(TYPE) %>%
    summarize(CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
              PERC_CARC_FAC_DENOM_TOTAL_IN_HUC = 
                n() / nrow(pbs_at_least_one) * 100,
              PERC_CARC_FAC_DENOM_TOTAL_OF_TYPE = 
                n() / TYPE_COUNT * 100,
              AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = 
                sum(POPULATION, na.rm = TRUE),
              JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = 
                sum(SECURELVL == "JUVENILE", na.rm = TRUE),
              PERC_JUV_CARC_FAC_DENOM_TOTAL_IN_HUC = 
                sum(SECURELVL == "JUVENILE", na.rm = TRUE) /
                nrow(pbs_at_least_one_juv) * 100,
              PERC_JUV_CARC_FAC_DENOM_TOTAL_OF_TYPE = 
                sum(SECURELVL == "JUVENILE", na.rm = TRUE) / 
                JUV_TYPE_COUNT * 100,
              AT_LEAST_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC =
                sum(POPULATION[SECURELVL == "JUVENILE"], na.rm = TRUE),
              NON_JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = 
                sum(SECURELVL != "JUVENILE", na.rm = TRUE),
              PERC_NON_JUV_CARC_FAC_DENOM_TOTAL_IN_HUC = 
                sum(SECURELVL != "JUVENILE", na.rm = TRUE) /
                (nrow(pbs_at_least_one) -
                   nrow(pbs_at_least_one_juv)) * 100,
              PERC_NON_JUV_CARC_FAC_DENOM_TOTAL_OF_TYPE = 
                sum(SECURELVL != "JUVENILE", na.rm = TRUE) /
                NON_JUV_TYPE_COUNT * 100,
              AT_LEAST_NON_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC =
                sum(POPULATION[SECURELVL != "JUVENILE"], na.rm = TRUE)) %>%
    distinct()
  
  
}

susp_by_pb_type <- by_type_table(pb_susp_cont_joined)
known_by_pb_type <- by_type_table(pb_pfas_joined)

write.csv(facility_type_totals, "final_datasets/facility_type_totals.csv")
write.csv(susp_by_pb_type, "final_datasets/susp_by_pb_type.csv")
write.csv(known_by_pb_type, "final_datasets/known_by_pb_type.csv")


```

### Perform Presumptive Point Source Calculations by Region

This takes the data frame created above in which each row represents a carceral facility/proximate PFAS point source pair. First it determines the distinct not closed carceral facilities that are proximate to at least one point source. The number of rows in this data frame is used as the denominator when calculating percentages in the first columns of this table. The number of rows in this data frame is used as the denominator when calculating percentages in the final columns of this table. It then calculates the number, percentage, and populations of not closed carceral facilities proximate to at least one point source by region.

```{r}
facility_region_totals <- 
  pb_huc_elevation %>%
  st_drop_geometry() %>%
  group_by(REGION) %>%
  summarize(REGION_COUNT = n(),
            JUV_REGION_COUNT = sum(SECURELVL == "JUVENILE", na.rm = TRUE),
            NON_JUV_REGION_COUNT = sum(SECURELVL != "JUVENILE", na.rm = TRUE),
            POP_COUNT = sum(POPULATION, na.rm = TRUE))

by_region_table <- function(source){
  
  pbs_at_least_one <- 
    source %>%
    select(FACILITYID, POPULATION, REGION, SECURELVL) %>%
    distinct()

  pbs_at_least_one_juv <-
    pbs_at_least_one %>%
    filter(SECURELVL == "JUVENILE")
  
  by_pb_region <-
    pbs_at_least_one %>%
    left_join(facility_region_totals, by = "REGION") %>%
    group_by(REGION) %>%
    summarize(CARC_FAC_WITH_POINT_SOURCE_IN_HUC = n(),
              PERC_CARC_FAC_DENOM_TOTAL_IN_HUC = 
                n() / nrow(pbs_at_least_one) * 100,
              PERC_CARC_FAC_DENOM_TOTAL_OF_REGION = 
                n() / REGION_COUNT * 100,
              AT_LEAST_CARC_POP_WITH_POINT_SOURCE_IN_HUC = 
                sum(POPULATION, na.rm = TRUE),
              JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = 
                sum(SECURELVL == "JUVENILE", na.rm = TRUE),
              PERC_JUV_CARC_FAC_DENOM_TOTAL_IN_HUC = 
                sum(SECURELVL == "JUVENILE", na.rm = TRUE) /
                nrow(pbs_at_least_one_juv) * 100,
              PERC_JUV_CARC_FAC_DENOM_TOTAL_OF_REGION = 
                sum(SECURELVL == "JUVENILE", na.rm = TRUE) / 
                JUV_REGION_COUNT * 100,
              AT_LEAST_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC =
                sum(POPULATION[SECURELVL == "JUVENILE"], na.rm = TRUE),
              NON_JUV_CARC_FAC_WITH_POINT_SOURCE_IN_HUC = 
                sum(SECURELVL != "JUVENILE", na.rm = TRUE),
              PERC_NON_JUV_CARC_FAC_DENOM_TOTAL_IN_HUC = 
                sum(SECURELVL != "JUVENILE", na.rm = TRUE) /
                (nrow(pbs_at_least_one) -
                   nrow(pbs_at_least_one_juv)) * 100,
              PERC_NON_JUV_CARC_FAC_DENOM_TOTAL_OF_REGION = 
                sum(SECURELVL != "JUVENILE", na.rm = TRUE) /
                NON_JUV_REGION_COUNT * 100,
              AT_LEAST_NON_JUV_CARC_POP_WITH_POINT_SOURCE_IN_HUC =
                sum(POPULATION[SECURELVL != "JUVENILE"], na.rm = TRUE)) %>%
    distinct()
  
  
}

susp_by_pb_region <- by_region_table(pb_susp_cont_joined)
known_by_pb_region <- by_region_table(pb_pfas_joined)

write.csv(susp_by_pb_region, "final_datasets/susp_by_pb_region.csv")
write.csv(known_by_pb_region, "final_datasets/known_by_pb_region.csv")


```


























